# MusicGPT Ranking Engine - Benchmark Results

> **Date:** 2026-02-08 | **Dataset:** 48 songs, 96 audio outputs | **Infra:** Docker Compose (pgvector/pg16, Redis 7, FastAPI)

## How to reproduce

```bash
# Full latency + scores + ranking improvement + concurrency test
docker compose exec api python scripts/benchmark.py

# Diversity proof (MMR genre spread)
docker compose exec api python scripts/test_diversity.py

# Ranking improvement + concurrency test
docker compose exec api python scripts/test_ranking.py --query "Christmas" --clicks 50
```

Results are saved to `results/benchmark_results.json` and `results/diversity_proof.json`.

---

## Search Latency (median, 3 runs per query)

| Query | Candidates | Results | Retrieval | Ranking | Rerank | Diversity | **Total** |
|-------|-----------|---------|-----------|---------|--------|-----------|-----------|
| Christmas (holiday) | 96 | 13 | ~45ms | 0.5ms | ~45ms | ~7ms | **98.7ms** |
| Upbeat pop (genre) | 96 | 16 | ~50ms | 0.5ms | ~43ms | ~10ms | **109.1ms** |
| Chill ambient (mood) | 96 | 14 | ~48ms | 0.6ms | ~42ms | ~8ms | **93.0ms** |
| Energetic dance (tempo) | 96 | 14 | ~50ms | 0.6ms | ~40ms | ~7ms | **95.8ms** |
| Sad piano ballad | 96 | 15 | ~48ms | 0.7ms | ~41ms | ~7ms | **92.2ms** |
| Hip hop rap confident | 96 | 15 | ~50ms | 0.7ms | ~38ms | ~8ms | **92.8ms** |
| Folk acoustic guitar | 96 | 15 | ~40ms | 0.5ms | ~38ms | ~9ms | **95.3ms** |
| Synthwave (subgenre) | 96 | 14 | ~43ms | 0.6ms | ~39ms | ~7ms | **95.8ms** |

**Median search latency: ~95ms** (4-stage pipeline: HNSW retrieval + composite scoring + neural rerank + MMR diversity)

## Filtered Search Latency

| Filter | Query | Results | Median |
|--------|-------|---------|--------|
| genre=pop | energetic dance | 20 | **77.6ms** |
| bpm 80-100 | mellow vibes | 16 | **54.7ms** |
| format=MUSIC | dark cinematic | 15 | **94.3ms** |

## Feedback Latency

| Metric | Value |
|--------|-------|
| Single click (median, 10 runs) | **10.1ms** |
| Single click (min) | 6.9ms |
| **50 concurrent clicks** | **1661ms wall, 50/50 success, 0 data loss** |
| Concurrent avg per request | 33.2ms |

---

## Diversity Proof (MMR)

> Generated by `scripts/test_diversity.py` -- saved to `results/diversity_proof.json`

### Query: "Pop" -- Top 6

Without MMR, pure relevance would stack all pop songs at the top. With MMR:

| # | Genre | Mood | Semantic | MMR | Redundancy | Title |
|---|-------|------|----------|-----|------------|-------|
| 1 | **pop** | hopeful | 0.3099 | 0.4128 | 0.0000 | Breaking Out |
| 2 | **world** | peaceful | 0.1558 | 0.2309 | 0.4654 | Kathmandu Dawn |
| 3 | **folk / acoustic** | romantic | 0.1676 | 0.1906 | 0.6070 | Family Hearth |
| 4 | pop | happy | 0.3217 | 0.1547 | 0.7227 | Weekend Vibes |
| 5 | **hip-hop / rap** | hopeful | 0.2924 | 0.1455 | 0.7084 | Breakout Beat |
| 6 | pop | hopeful | 0.2903 | 0.1256 | 0.7854 | Let It Out |

**4 unique genres** | Max genre share: 50% | `PASS`

Positions 2, 3, 5 are **not pop** despite pop songs having higher semantic scores -- MMR injected `world`, `folk/acoustic`, and `hip-hop/rap` because each was dissimilar to already-selected items.

### Query: "Christmas holiday festive" -- Top 8

| # | Genre | Mood | Semantic | MMR | Redundancy | Title |
|---|-------|------|----------|-----|------------|-------|
| 1 | **folk / acoustic** | romantic | 0.4314 | 0.4077 | 0.0000 | Family Hearth |
| 2 | **metal** | aggressive | 0.1725 | 0.2059 | 0.4292 | Screams of the Mountain |
| 3 | **world** | peaceful | 0.2020 | 0.1953 | 0.6070 | Kathmandu Dawn |
| 4 | **pop** | hopeful | 0.1521 | 0.1940 | 0.5880 | Breaking Out |
| 5 | pop | happy | 0.4411 | 0.1636 | 0.7250 | Snowy Holiday Nights |
| 6 | folk / acoustic | energetic | 0.1985 | 0.1494 | 0.6191 | Kathmandu Rhythms |
| 7 | **electronic** | energetic | 0.1391 | 0.1477 | 0.6181 | Midnight Pulse |
| 8 | electronic | chill | 0.1582 | 0.1220 | 0.7038 | Midnight Breeze |

**5 unique genres** | Max genre share: 25% | `PASS`

"Snowy Holiday Nights" has the **highest** semantic score (0.4411) but lands at #5, not #1 -- its redundancy (0.7250) against already-selected folk/metal/world/pop items penalizes it. This is the "Christmas Pop domination" prevention.

### Query: "chill ambient relaxing" -- Top 5

| # | Genre | Mood | Semantic | MMR | Redundancy | Title |
|---|-------|------|----------|-----|------------|-------|
| 1 | **world** | peaceful | 0.5375 | 0.4251 | 0.0000 | Kathmandu Dawn |
| 2 | **pop** | hopeful | 0.2703 | 0.2438 | 0.4654 | Breaking Out |
| 3 | **folk / acoustic** | romantic | 0.4094 | 0.2230 | 0.6070 | Family Hearth |
| 4 | **soundtrack** | dark | 0.3148 | 0.1897 | 0.5518 | Infinity's Shadow |
| 5 | **electronic** | chill | 0.4571 | 0.1897 | 0.6390 | Midnight Study |

**5 unique genres in top-5** | Max genre share: 20% | `PASS`

### All Diversity Results

| Query | Unique Genres | Max Genre % | Result |
|-------|:------------:|:-----------:|:------:|
| Pop | 4 | 50% | PASS |
| Christmas holiday festive | 5 | 25% | PASS |
| energetic dance beat | 5 | 25% | PASS |
| chill ambient relaxing | 7 | 20% | PASS |
| upbeat pop | 4 | 50% | PASS |

**5/5 passed** -- no single genre ever exceeds 50% of top results.

---

## Score Breakdown: Top 5 per Query

### "electronic synthwave neon"

| # | Title | Genre | Semantic | Popularity | Composite | Final | MMR |
|---|-------|-------|----------|------------|-----------|-------|-----|
| 1 | Neon Drift | electronic | **0.6379** | 0.5000 | 0.6414 | 0.5866 | 0.4106 |
| 2 | Family Hearth | folk / acoustic | 0.2236 | 1.0000 | 0.6071 | 0.5428 | 0.2297 |
| 3 | Kathmandu Dawn | world | 0.2673 | 1.0000 | 0.6331 | 0.5532 | 0.2052 |
| 4 | Screams of the Mountain | metal | 0.3183 | 0.5000 | 0.5194 | 0.5078 | 0.1929 |
| 5 | Midnight Pulse | electronic | 0.4015 | 0.5000 | 0.5619 | 0.5250 | 0.1848 |

> "Neon Drift" ranks #1 with highest semantic score (0.64) for synthwave query.

### "hip hop rap confident"

| # | Title | Genre | Semantic | Popularity | Composite | Final | MMR |
|---|-------|-------|----------|------------|-----------|-------|-----|
| 1 | Breaking Out | hip-hop / rap | **0.5905** | 0.5000 | 0.6128 | 0.5751 | 0.4026 |
| 2 | Kathmandu Dawn | world | 0.1736 | 1.0000 | 0.5857 | 0.5343 | 0.2363 |
| 3 | Bhrashtachar | metal | 0.3033 | 0.5000 | 0.5227 | 0.5091 | 0.1963 |
| 4 | Weekend Vibes | pop | 0.3550 | 0.5000 | 0.5433 | 0.5173 | 0.1948 |
| 5 | Family Hearth | folk / acoustic | 0.1782 | 1.0000 | 0.5883 | 0.5353 | 0.1927 |

---

## Ranking Improvement Proof (Self-Optimizing)

> Generated by `scripts/test_ranking.py`

**Test:** 50 clicks on a position-6 item, then re-search.

| Metric | Before | After 50 Clicks | Delta |
|--------|--------|-----------------|-------|
| **Position** | 6 | **3** | **+3 up** |
| Popularity Score | 0.5000 | **1.0000** | +0.50 |
| Composite Score | 0.4553 | **0.5807** | +0.13 |

**Target:** `Kathmandu Dawn` (output `b89308da`) for query "Christmas"

## Thread-Safety Proof (Concurrent Clicks)

| Metric | Value |
|--------|-------|
| Concurrent requests sent | 50 |
| Successful responses | **50/50** |
| Data loss | **0** |
| Clicks in DB match expected | **Yes** |
| Wall time | 1661ms |
| Mechanism | PostgreSQL `ON CONFLICT DO UPDATE` atomic UPSERT |

---

## Pipeline Stages

```
Query → [Embedding Cache (Redis)] → [HNSW ANN Retrieval (500)] → [Composite Scoring (50)]
  → [Neural Reranking - FlashRank (30)] → [MMR Diversity (20)] → Results
```

| Stage | Algo | Avg Time |
|-------|------|----------|
| Retrieval | HNSW cosine_distance + pgvector | ~48ms |
| Ranking | IPW debiased popularity + Thompson Sampling + freshness | <1ms |
| Reranking | FlashRank TinyBERT cross-encoder | ~40ms |
| Diversity | MMR + genre slot allocation | ~8ms |

## Scripts

| Script | Purpose | Output |
|--------|---------|--------|
| `scripts/benchmark.py` | Full latency + scores + ranking + concurrency | `results/benchmark_results.json` |
| `scripts/test_diversity.py` | MMR diversity proof across 5 queries | `results/diversity_proof.json` |
| `scripts/test_ranking.py` | 50-click ranking improvement + concurrent safety | stdout |
| `scripts/ingest.py` | DynamoDB JSON ingestion + embedding generation | DB |

> Raw data: [`results/benchmark_results.json`](results/benchmark_results.json) | [`results/diversity_proof.json`](results/diversity_proof.json)
